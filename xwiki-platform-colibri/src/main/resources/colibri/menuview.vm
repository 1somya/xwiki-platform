#if($context.getMode()==0)## Visible only in a page
<div id="mainmenu" class="layoutsubsection actionmenu">
<strong id="xwikimenutitle" class="hidden">$msg.get('menu')</strong>
<div class="rightmenu">
##
## User
##
#if(!$context.action.startsWith('login'))
  #if($isGuest)
    #set($loginurl = $xwiki.getURL('XWiki.XWikiLogin', 'login', "xredirect=$util.encodeURI($xwiki.getRequestURL())"))
    #xwikitopmenuentry($!loginurl $!msg.get('login') 'tmLogin')
  #else
    #set($logouturl = $xwiki.getURL('XWiki.XWikiLogout', 'logout', "xredirect=$util.encodeURI($xwiki.getRequestURL())"))
    #xwikitopmenuentry($!logouturl $!msg.get('logout') 'tmLogout')
  #end
#end
#if($isGuest && $xwiki.hasAccessLevel('register', 'XWiki.XWikiPreferences'))
  #set($regurl = $xwiki.getURL('XWiki.Register', 'register'))
  #xwikitopmenuentry($!regurl $!msg.get('core.register') 'tmRegister')
#end
##
##
#if (!$isGuest)
#if ($context.user == 'XWiki.superadmin')
  #xwikitopmenuentry('#' $!msg.get('superadmin') 'tmUser')
#else
  #xwikitopmenuentrystart($xwiki.getURL($context.user, 'view') $!xwiki.getUserName($context.user, false) 'tmUser' 'hasIcon')
  #submenuitem($xwiki.getURL('XWiki.WatchListManager', 'view') $msg.get('core.menu.watchlist.management') 'tmWatchlistManager', '')
  #xwikitopmenuentryend()
#end
#end
</div>
<div class="leftmenu">
#set ($adminapppresent = $xwiki.exists('XWiki.AdminSheet'))
##
## Wiki
##
#if(!$hasEdit)
  #xwikitopmenuentry($xwiki.getURL('Main.WebHome', 'view') $context.getDatabase() 'tmWiki' 'hasIcon')
#else
  #xwikitopmenuentrystart($xwiki.getURL('Main.WebHome', 'view') $context.getDatabase() 'tmWiki' 'hasIcon')
  #submenuitem($xwiki.getURL('XWiki.CreatePage', 'view', "tocreate=space&amp;parent=$doc.fullName") $msg.get('core.menu.create.space') 'tmCreateSpace', '')
  #set ($isWikiWatched = $xwiki.watchlist.isWikiWatched())
  #if (!$isWikiWatched)
    #submenuitem("$doc.getURL('view', 'xpage=watch&amp;do=addwiki')&amp;xredirect=$doc.getURL()" $msg.get('core.menu.watchlist.add.wiki', [$xwiki.getXMLEncoded($doc.wiki)]) 'tmWatchWiki', '')
  #else
    #submenuitem("$doc.getURL('view', 'xpage=watch&amp;do=removewiki')&amp;xredirect=$doc.getURL()" $msg.get('core.menu.watchlist.remove.wiki') 'tmUnwatchWiki', '')
  #end
  #set ($hasAdminWikiRights = $xwiki.hasAccessLevel('admin', 'XWiki.XWikiPreferences'))
  #if($hasAdminWikiRights)
    #set ($adminwikiaction = $!xwiki.getURL('XWiki.XWikiPreferences', 'admin'))
    #set ($importaction = $!xwiki.getURL('XWiki.XWikiPreferences', 'import'))
    #if($adminapppresent)
      #submenuitem($adminwikiaction $msg.get('core.menu.admin.wiki') 'tmAdminWiki', '')
    #else
      #xwikitopmenuentry($importaction $msg.get('core.menu.admin') 'tmAdmin')
    #end
  #end
  #xwikitopmenuentryend()  
#end
##
## Space
##
#if(!$hasEdit)
  #xwikitopmenuentry($xwiki.getURL("${doc.space}.WebHome", 'view') $doc.space 'tmSpace' 'hasIcon')
#else
  #xwikitopmenuentrystart($xwiki.getURL("${doc.space}.WebHome", 'view') $doc.space 'tmSpace' 'hasIcon')
  #set ($hasAdminSpaceRights = $xwiki.hasAccessLevel('admin', "${doc.space}.XWikiPreferences"))  
  #submenuitem($xwiki.getURL('XWiki.CreatePage', 'view', "tocreate=page&amp;parent=$doc.fullName") $msg.get('core.menu.create.page') 'tmCreatePage', '')
  #submenuitem($xwiki.getURL('XWiki.OfficeImporter', 'view', "&amp;parent=$doc.fullName") $msg.get('core.menu.create.pageFromOffice') 'tmCreatePageFromOffice', '')
  #set ($isSpaceWatched = $xwiki.watchlist.isSpaceWatched())
  #if (!$isSpaceWatched)
    #submenuitem("$doc.getURL('view', 'xpage=watch&amp;do=addspace')&amp;xredirect=$doc.getURL()" $msg.get('core.menu.watchlist.add.space', [$xwiki.getXMLEncoded($doc.space)]) 'tmWatchSpace', '')
  #else
    #submenuitem("$doc.getURL('view', 'xpage=watch&amp;do=removespace')&amp;xredirect=$doc.getURL()" $msg.get('core.menu.watchlist.remove.space') 'tmUnwatchSpace', '')
  #end
  #if($hasAdminSpaceRights && $adminapppresent)
    #set ($adminspaceaction = $!xwiki.getURL("${doc.space}.WebPreferences", 'admin'))
    #submenuitem($adminspaceaction $msg.get('core.menu.admin.space', [$xwiki.getXMLEncoded($doc.space)]) 'tmAdminSpace')
  #end
  #xwikitopmenuentryend()
#end
</div>
</div>
#end
