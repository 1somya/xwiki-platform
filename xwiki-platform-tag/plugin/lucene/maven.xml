<?xml version="1.0" encoding="UTF-8"?>
<project
	default="jar" xmlns:velocity="jelly:velocity" xmlns:maven="jelly:maven"
	xmlns:j="jelly:core" xmlns:util="jelly:util" xmlns:ant="jelly:ant" xmlns:deploy="deploy">

  <goal name="deploy" prereqs="dist">
		<ant:exec dir="." executable="/bin/bash" failonerror="true">
			<ant:arg line="-c 'scp -r ${maven.dist.dir}/* ${deployment.target}'" />
		</ant:exec>
	</goal>

  <postGoal name="dist:prepare-bin-filesystem">
    <attainGoal name="copydeps" />
  </postGoal>

  <goal name="copydeps">
    <mkdir dir="${maven.build.dir}/${maven.final.name}/bin/${maven.final.name}/lib" />
		<deploy:copy-deps todir="${maven.build.dir}/${maven.final.name}/bin/${maven.final.name}/lib" excludes="xwiki,junit,asm,groovy,log4j,commons-collections,commons-lang"/>
  </goal>

  <preGoal name="test:single">
		<attainGoal name="groovy:compile-tests"/>
  </preGoal>

	<goal name="setclasspath">
		<path id="test.classpath">
			<pathelement path="${maven.build.dest}"/>
			<pathelement path="${maven.build.dir}/test-classes"/>
			<path refid="maven.dependency.classpath"/>
		</path>
		<taskdef name="groovyc" classname="org.codehaus.groovy.ant.Groovyc" classpathref="test.classpath"/>
	</goal>

	<goal name="groovy:compile-tests" prereqs="java:compile, test:compile, setclasspath"
		description="Compiles the Groovy unit test cases">
    <!-- lets copy and touch all the groovy files to ensure they all recompile -->
		<mkdir dir="${maven.build.dir}/test-classes"/>
		<copy todir="${maven.build.dir}/test-classes">
			<fileset dir="${basedir}/test/src">
				<include name="**/*.groovy"/>
				<exclude name="**/notworking/*.groovy"/>
				<!--        <exclude name="**/BaseComponentTest.groovy"/>-->
				<exclude name=".svn/*"/>
			</fileset>
		</copy>
		<touch>
			<fileset dir="${maven.build.dir}/test-classes" includes="**/*.groovy"/>
		</touch>
		<groovyc destdir="${maven.build.dir}/test-classes" srcdir="${maven.build.dir}/test-classes" listfiles="true">
			<classpath refid="test.classpath"/>
		</groovyc>
	</goal>

	<goal name="groovy:test-single" prereqs="groovy:compile-tests" description="Runs a named groovy test case using the 'test' property">
		<java classname="groovy.util.GroovyTestSuite" fork="yes">
			<classpath refid="test.classpath"/>
			<sysproperty key="test" value="${test}"/>
		</java>
	</goal>


	<goal name="groovy:test-quick" prereqs="clean" description="Tries running all the unit test cases in the same JVM">
		<attainGoal name="clean"/>
		<attainGoal name="groovy:compile-tests"/>
		<j:set var="testcase" value="org.codehaus.groovy.tools.FindAllTestsSuite"/>
		<j:set var="maven.junit.usefile" value="false"/>
		<attainGoal name="test:single"/>
	</goal>
	
	<goal name="clean">
		<ant:delete includeEmptyDirs="true">
			<ant:fileset dir="${maven.build.dir}" excludes="eclipse*/**" />
		</ant:delete>
	</goal>

</project>
