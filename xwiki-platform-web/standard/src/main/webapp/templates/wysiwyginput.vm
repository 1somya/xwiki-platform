## Make sure the XWiki velocity variables are defined when the edited content is rendered.
#template("xwikivars.vm")
## The XML declaration is commented out to avoid quirks mode in IE6.
##<?xml version="1.0" encoding="$xwiki.encoding" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="$context.language" xml:lang="$context.language">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=$xwiki.encoding" />
## Include the stylesheets that affect the content in view mode.
#template("stylesheets.vm")
## RichTextArea.css overwrites those CSS rules defined in the previous stylesheets that are improper in edit mode.
<link type="text/css" rel="stylesheet" href="$xwiki.getSkinFile("js/xwiki/wysiwyg/xwe/stylesheets/RichTextArea.css")"/>
## Include the scripts that affect the content in view mode.
#template("javascript.vm")
<script type="text/javascript">
// <![CDATA[
// Don't cancel the edit when the edited document is reloaded.
Event.stopObserving(window, "unload", cancelEdit);
Event.stopObserving(window, "pagehide", cancelEdit);
// ]]>
</script>
</head>
## We don't use directly $tdoc.content because we could loose changes made by the 
## user before switching from wiki editor to wysiwyg or before saving when a 
## conversion exception is thrown.
#set($content = $tdoc.content)
#set($render = ("$!request.render" == "true"))
#if("$!request.key" != "")
  #set($wysiwygInput = $request.getSession().getAttribute("com.xpn.xwiki.wysiwyg.input"))
  #if($wysiwygInput && $wysiwygInput.containsKey($request.key))
    #set($content = $wysiwygInput.get($request.key))
    #set($ok = $wysiwygInput.remove($request.key))
  #elseif($request.getParameterMap().containsKey("source"))
    #set($content = $request.source)
  #elseif($request.getParameterMap().containsKey("html"))
    #set($render = false)
    #set($content = $xwiki.wysiwyg.parseAndRender($request.html, $tdoc.getSyntaxId()))
  #end
#end
## We don't always have to render the content:
## * If this template is called after a conversion exception then the content is HTML.
## * If the WYSIWYG is in real time mode then the content must be empty.
#if($render)
  ## We render using the Annotated XHTML Renderer since we need the extra metadata in order to be able to do full
  ## Round tripping between HTML and Wiki syntax.
  #set($content = $tdoc.getRenderedContent($content, $tdoc.getSyntaxId(), "annotatedxhtml/1.0"))
#end
<body id="body" class="main">$content</body>
</html>
