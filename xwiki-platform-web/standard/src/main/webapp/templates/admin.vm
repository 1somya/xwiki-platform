##-------------------------------------------------
## Determine whether the admin sheet is available
##-------------------------------------------------
#if($xwiki.exists("XWiki.AdminSheet"))
 #set($adminSheetExists = true)
#else
 #set($adminSheetExists = false)
#end
##-------------------------------------------------
## Determine which editor to use (global or space)
##-------------------------------------------------
#if((!$editor) || ($editor == ""))
  #set($editor = $request.getParameter("editor"))
  #if((!$editor) || ($editor == ""))
    #if($doc.fullName == "XWiki.XWikiPreferences")
      #set($editor = "globaladmin")
    #elseif($doc.name == "WebPreferences")
      #set($editor = "spaceadmin")
    #else
      #set($editor = "globaladmin") ## default editor
    #end
  #end
#end
##-------------------------------------------------
##   Determine the current space, section and admin doc
##-------------------------------------------------
#set($currentSpace = $request.space)
#if(!$currentSpace)
 #set($currentSpace = $doc.web)
#end
#if($editor == "globaladmin")
  #set($currentDoc = "XWiki.XWikiPreferences")
#else
  #set($currentDoc = "${currentSpace}.WebPreferences")
#end
#set($section = "$!{request.section}")
##-------------------------------------------------
##  Start page 
##-------------------------------------------------
#template("startpage.vm")
##-------------------------------------------------
## Include AdminSheet and XWikiPreferences obj.
##-------------------------------------------------
#set($include = '#includeForm("XWiki.AdminSheet")')
#if($doc.fullName == "XWiki.XWikiPreferences" || $doc.name == "WebPreferences")
  #if ($doc.getContent().indexOf("XWiki.AdminSheet") < 0)
    #set($discard = $doc.setContent($include))
    #set($needsupdate = true)
  #end
  #set($obj = $doc.getObject("XWiki.XWikiPreferences"))
  #set($prefsclassname = "XWiki.XWikiPreferences")
  #set($class = $xwiki.getDocument($prefsclassname).xWikiClass)
  #if(!$obj)
    #set($obj = $doc.newObject($prefsclassname))
    #set($needsupdate = true)
  #end
  #if($needsupdate)
    #set($discard = $doc.save())
  #end
#end
##-------------------------------------------------
##  Content (if empty wiki display Import & Export)
##-------------------------------------------------
<div class="main layoutsubsection">
#set($force = $!request.get("force"))
#if(!$hasAdmin)
  #xwikimessageboxstart($msg.get("error") $msg.get('notallowed'))
  #xwikimessageboxend()
#elseif (($tdoc.getLocked() == true) && (!$force))
  #xwikimessageboxstart($msg.get("notice") "$msg.get('doclockedby') $xwiki.getLocalUserName($doc.getLockingUser())")
  <a href="$doc.getURL($context.action, "$!{request.getQueryString().replaceAll('&', '&amp;').replaceAll('&amp;amp;', '&amp;')}&amp;force=1")">$msg.get("forcelock")</a>
  #xwikimessageboxend()
#else 
  #if($xwiki.exists("XWiki.AdminSheet"))
    $xwiki.getDocument("XWiki.AdminSheet").getTranslatedDocument().getRenderedContent()
  #else ## empty wiki, display only Import and Export
    <div id="admin-page">
      <div id="admin-page-header">
        <h1 id="admin-header">#if($section == "")$msg.get("admin.${editor}")#else$msg.get("admin.${section.toLowerCase()}")#end</h1>
	    #if($section != "")<div id="show-all"><a href="$xwiki.getURL($currentDoc, "admin")">$msg.get("admin.showall")</a></div>#end
        <div id="change-context">
        #if("$!{editor}" == "globaladmin")<span class="admin-a-space">$msg.get("admin.adminspace")</span>
        #else
          <span class="go-to-globaladmin"><a href="$xwiki.getURL("XWiki.XWikiPreferences","admin")">$msg.get("admin.gotoglobaladmin")</a></span><br /><span class="admin-another-space">$msg.get("admin.adminotherspace")</span> 
        #end
        #xwikitopmenuentrystart("#" $msg.get("admin.selectspace") "change-context-select")
        #foreach($spaceitem in $xwiki.spaces)
          #submenuitem($xwiki.getURL("${spaceitem}.WebPreferences", "admin") $spaceitem)
        #end
        #xwikitopmenuentryend()
      </div> ## change-context
    </div> ## admin-page-header
	#if($section == "")
      <div id="admin-page-menu">
        <ul id="admin-icons">
         <li class="Import"><a href="$xwiki.getURL("XWiki.Import", "import", "editor=globaladmin&amp;section=Import&amp;space=XWiki")"><span>$msg.get("admin.import")</span></a></li>
         #if($hasGlobalAdmin)
         <li class="Export"><a href="$xwiki.getURL("XWiki.Export", "export", "editor=globaladmin&amp;section=Export&amp;space=XWiki")"><span>$msg.get("admin.export")</span></a></li>
         #end
        </ul>
      </div> ## admin-page-menu
	#else
      <div id="admin-page-content">
       #template("${request.section.toLowerCase()}inline.vm")
      </div>
    #end
  </div>  ## admin-page  
   #end       
 #end
</div>
##-------------------------------------------------
##  End page 
##-------------------------------------------------
#template("endpage.vm")