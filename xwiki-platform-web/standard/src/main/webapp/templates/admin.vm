##-------------------------------------------------
## Determine whether the admin sheet is available
##-------------------------------------------------
#if($xwiki.exists("XWiki.AdminSheet"))
 #set($adminSheetExists = true)
#else
 #set($adminSheetExists = false)
#end
##-------------------------------------------------
## Determine which editor to use (global or space)
##-------------------------------------------------
#if((!$editor) || ($editor == ""))
  #set($editor = $request.getParameter("editor"))
  #if((!$editor) || ($editor == ""))
    #if($doc.fullName == "XWiki.XWikiPreferences")
      #set($editor = "globaladmin")
    #elseif($doc.name == "WebPreferences")
      #set($editor = "spaceadmin")
    #else
      #set($editor = "globaladmin") ## default editor
    #end
  #end
#end
##-------------------------------------------------
##   Determine the current space, section and admin doc
##-------------------------------------------------
#set($currentSpace = $request.space)
#if(!$currentSpace)
 #set($currentSpace = $doc.web)
#end
#if($editor == "globaladmin")
  #set($currentDoc = "XWiki.XWikiPreferences")
#else
  #set($currentDoc = "${currentSpace}.WebPreferences")
#end
#set($section = "$!{request.section}")
##-------------------------------------------------
##  Start page
##-------------------------------------------------
#template("startpage.vm")
##-------------------------------------------------
## Include AdminSheet and XWikiPreferences obj.
##-------------------------------------------------
#set($include = '#includeForm("XWiki.AdminSheet")')
#if($doc.fullName == "XWiki.XWikiPreferences" || $doc.name == "WebPreferences")
  #if ($doc.getContent().indexOf("XWiki.AdminSheet") < 0)
    #set($discard = $doc.setContent($include))
    #set($needsupdate = true)
  #end
  #set($obj = $doc.getObject("XWiki.XWikiPreferences"))
  #set($prefsclassname = "XWiki.XWikiPreferences")
  #set($class = $xwiki.getDocument($prefsclassname).xWikiClass)
  #if(!$obj)
    #set($obj = $doc.newObject($prefsclassname))
    #set($needsupdate = true)
  #end
  #if($needsupdate)
    #set($discard = $doc.save())
  #end
#end
##-----------------------------------------
##  Content (if empty wiki display Import)
##-----------------------------------------
<div class="main layoutsubsection">
#set($force = $!request.get("force"))
#if(!$hasAdmin)
  #xwikimessageboxstart($msg.get("error") $msg.get('notallowed'))
  #xwikimessageboxend()
#elseif (($tdoc.getLocked() == true) && (!$force))
  #xwikimessageboxstart($msg.get("notice") "$msg.get('doclockedby') $xwiki.getLocalUserName($doc.getLockingUser())")
  <a href="$doc.getURL($context.action, "$!{request.getQueryString().replaceAll('&', '&amp;').replaceAll('&amp;amp;', '&amp;')}&amp;force=1")">$msg.get("forcelock")</a>
  #xwikimessageboxend()
#else 
  #if($xwiki.exists("XWiki.AdminSheet"))
    $xwiki.getDocument("XWiki.AdminSheet").getTranslatedDocument().getRenderedContent()
  #else ## empty wiki, display only Import
    <div id="admin-page">
      <div id="admin-page-header">
        <h1 id="admin-header">$msg.get("admin.import")</h1>
      </div> ## admin-page-header
      <div id="admin-page-content">
        #template("importinline.vm")
      </div> ## admin-page-menu
  </div>  ## admin-page
   #end
 #end
</div>
##-------------------------------------------------
##  End page
##-------------------------------------------------
#template("endpage.vm")