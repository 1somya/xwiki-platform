<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
<web>XWiki</web>
<name>ResetPassword</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>XWiki.WebHome</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1219710939000</creationDate>
<date>1219710939000</date>
<contentUpdateDate>1219710939000</contentUpdateDate>
<version>1.1</version>
<title>Reset password (step 1)</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>First version</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/1.0</syntaxId>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>4</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>4</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>4</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPassword</name>
<number>3</number>
<className>XWiki.XWikiRights</className>
<property>
<allow>0</allow>
</property>
<property>
<groups>XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>edit</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>4</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>4</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>4</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPassword</name>
<number>5</number>
<className>XWiki.XWikiRights</className>
<property>
<allow>0</allow>
</property>
<property>
<levels>edit</levels>
</property>
<property>
<users>XWiki.XWikiGuest</users>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>4</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>4</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>4</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPassword</name>
<number>7</number>
<className>XWiki.XWikiRights</className>
<property>
<allow>0</allow>
</property>
<property>
<groups>xwiki:XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>edit</levels>
</property>
</object>
<content>#**
This page starts the password reset procedure. It works according to the next algorithm:
1. Display a form requesting the username
2. When receiving the username via form submission, generate a random verification string which is stored (as a hash) inside a ResetPasswordRequestClass object attached to the user's profile page. If no such object exists, it is created, but an existing object will be reused, meaning that at most one password reset request can be active at a moment.
3. Send an email to the address configured in the user's profile, containing a link to the second step of the password reset procedure.

URL parameters:

u = user account sent in the form

!!!!! IMPORTANT !!!!!

This document requires programming rights, so always make sure
it is saved by a user with programming rights, and that
it is secured against unprivileged editing.

*#
##
##
## First, check if the page has programming rights, as nothing works otherwise
#if($xwiki.hasProgrammingRights())
##
##
## The name of the class used for storing password reset verification data.
#set($verifClass = "XWiki.ResetPasswordRequestClass")
#set($userName = "$!request.get('u')")
#if($userName == '') ## First step, display the form requesting the username
  1 Forgot your password?

  Please enter your username to start the password recovery process.

  &lt;form method="post" action=""&gt;
  &lt;div&gt;Username: &lt;input type="text" name="u"/&gt; &lt;input type="submit" value="Reset password"/&gt;&lt;/div&gt;
  &lt;/form&gt;
#else ## Second step, generate the verification string, store it, and send the email
  ## TODO: Once the usernames are not bound to the XWiki space, revisit this code
  #if($userName.indexOf('.') != -1)
    #set($userDoc = $xwiki.getDocument(${userName}))
  #else
    #set($userDoc = $xwiki.getDocument("XWiki.${userName}"))
  #end
  ## Check if the user exists and has a valid email address configured in his profile
  #set($userObj = "")
  #set($userObj = $userDoc.getObject('XWiki.XWikiUsers'))
  #if("$!userObj" == "")
    #warning("The user ~~$userName~~ does not exist.")
  #else
    #set($userEmail = $userObj.getProperty("email").value)
    #if("$!userEmail" == "")
      #error("Cannot reset password: email address not provided in the user profile.")
    #else
      ## Find the object that will hold the verification string
      #set($verifObj = "")
      #set($verifObj = $userDoc.getObject($verifClass))
      #if("$!verifObj" == "")
        #set($verifObj = $userDoc.newObject($verifClass))
      #end
      ## Generate a random string
      #set($verifStr = $xwiki.generateRandomString(30))
      ## If the class is correctly configured, the string should automatically be stored as a hash
      $verifObj.set("verification", $verifStr)
      $userDoc.saveWithProgrammingRights()
      ## Compose the verification URL
      #set($passwordResetURL = $xwiki.getDocument("XWiki.ResetPasswordComplete").getExternalURL("view", "u=${userName}&amp;amp;v=${verifStr}"))
      ## Send an email; the variables will be retrieved from the velocity context
      #set($mailResult = $xwiki.mailsender.sendMessageFromTemplate($xwiki.getXWikiPreference('admin_email', 'no-reply@xwiki.org'), $userEmail, $util.null, $util.null, $context.language, "XWiki.ResetPasswordMailContent", $context.vcontext))
      #if($mailResult == 0)
        #info("An e-mail was sent to &lt;tt&gt;${userEmail}&lt;/tt&gt;. Please follow the instructions in that e-mail to complete the password reset procedure.")
      #else
        #error("An unknown problem occured while sending the reset email.")
      #end
    #end
  #end
  &lt;a href="$doc.getURL()"&gt;&amp;laquo; Retry&lt;/a&gt; |
  &lt;a href="$xwiki.getURL("XWiki.XWikiLogin", "login", "")"&gt;Login &amp;raquo;&lt;/a&gt;
#end
## Clear private variables, so that they cannot be accessed from the rest of the page (comments, panels...)
#set($verifStr = "")
#set($passwordResetURL = "")
##
##
#else ## No programming rights, warn and exit
  #error("This page requires programming rights to work, which currently isn't true. Please notify an administrator of this problem and try again later.")
#end</content>
</xwikidoc>
