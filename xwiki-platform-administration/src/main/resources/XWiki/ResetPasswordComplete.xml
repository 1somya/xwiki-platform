<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>XWiki</web>
<name>ResetPasswordComplete</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>XWiki.WebHome</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1219710939000</creationDate>
<date>1219710939000</date>
<contentUpdateDate>1219710939000</contentUpdateDate>
<version>1.1</version>
<title>Reset password (step 2)</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPasswordComplete</name>
<number>1</number>
<className>XWiki.XWikiRights</className>
<guid>7fd88649-d66d-442a-bcee-bc4147e410a7</guid>
<property>
<allow>0</allow>
</property>
<property>
<groups>xwiki:XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>edit</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPasswordComplete</name>
<number>3</number>
<className>XWiki.XWikiRights</className>
<guid>e0264a66-4a10-4d7e-822e-6863e3caaa17</guid>
<property>
<allow>0</allow>
</property>
<property>
<groups>XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>edit</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<usesList>1</usesList>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>XWiki.ResetPasswordComplete</name>
<number>5</number>
<className>XWiki.XWikiRights</className>
<guid>bb790edf-7dcc-4646-9cf9-855b439cef7f</guid>
<property>
<allow>0</allow>
</property>
<property>
<levels>edit</levels>
</property>
<property>
<users>XWiki.XWikiGuest</users>
</property>
</object>
<content>{{velocity output="false"}}
#**
This page completes the password reset procedure. It works according to the next algorithm:
1. Verify that the correct verification URL is entered, by checking the 'u' and 'v' request parameters against the existing ResetPasswordRequest objects
2. Display a form requesting the new password
3. When receiving the new password via form submission, update the user object with the new password, and remove the ResetPasswordRequest object

URL parameters:

u = user account in the verification URL
v = random verification string
p = the new password
p2 = the new password (for misspelling check)

!!!!! IMPORTANT !!!!!

This document requires programming rights, so always make sure
it is saved by a user with programming rights, and that
it is secured against unprivileged editing.

*###
##
##
## The name of the class used for storing password reset verification data.
#set($verifClass = 'XWiki.ResetPasswordRequestClass')
##
## START MACROS
##
#**
 * Encrypt a string to get the value that would be stored inside a PasswordProperty field.
 * It is used to check if the unencrypted parameter from the URL is the value stored in the
 * ResetPasswordRequest object.
 * @param value The plaintext value to encrypt.
 * @param result The encrypted output.
 *#
#macro(encrypt $value $result)
  #set($result = $xwiki.getDocument($verifClass).getxWikiClass().getXWikiClass().get('verification').getPasswordHash($value))
#end
##
##
#**
 * Verify that the request parameters are valid.
 * @param userName The user name (full document name) received in the URL.
 * @param validationString The unencrypted key that is stored in the ResetPasswordRequestClass object.
 * @param result A boolean where the validation result is returned. True if the request is valid, false otherwise.
 *#
#macro(verifyRequest $userName $validationString $result)
  #set($result = false)
  #if($validationString != '' &amp;&amp; $userName != '')
    #encrypt($validationString $encryptedValidationString)
    #if("$!xwiki.getDocument($userName).getObject($verifClass).getProperty('verification').getValue()" == $encryptedValidationString)
      #set($result = true)
    #end
  #end
#end
##
##
#**
 * Displays the password reset form.
 * @param message An optional message to display, for example if the sent password is empty.
 * @param u The user account (full document name), which needs to be preserved.
 * @param v The validation string, which will be checked again upon receiving the form.
 *###
#macro(displayForm $message $userName $validationString)
  = $msg.get('xe.admin.passwordreset.resetfor', [${xwiki.getUserName($userName, false)}]) =
  #if($message != '')

{{warning}}$message{{/warning}}
  #end

{{html}}
  &lt;form action="$doc.getURL()" method="post" onsubmit="if($('p').value == '') {alert('$msg.get("xe.admin.passwordreset.emptystring")'); return false;} else if($('p').value != $('p2').value) {alert('$msg.get("xe.admin.passwordreset.nomatch")'); return false; }"&gt;
    &lt;div class="hidden"&gt;
      &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
      &lt;input type="hidden" name="u" value="$!escapetool.xml($userName)"/&gt;
      &lt;input type="hidden" name="v" value="$!escapetool.xml($validationString)"/&gt;
    &lt;/div&gt;
    &lt;dl&gt;
      &lt;dt&gt;&lt;label for="p"&gt;$msg.get('xe.admin.passwordreset.newpassword')&lt;/label&gt;&lt;/dt&gt;
      &lt;dd&gt;&lt;input id="p" type="password" name="p" value="" size="20"/&gt;&lt;/dd&gt;
      &lt;dt&gt;&lt;label for="p2"&gt;$msg.get('xe.admin.passwordreset.reenterpassword')&lt;/label&gt;&lt;/dt&gt;
      &lt;dd&gt;&lt;input id="p2" type="password" value="" name="p2" size="20"/&gt;&lt;/dd&gt;
    &lt;/dl&gt;
    &lt;div&gt;
      &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="$msg.get('xe.admin.passwordreset.save')" class="button"/&gt;&lt;/span&gt;
    &lt;/div&gt;
  &lt;/form&gt;
{{/html}}

#end
##
## END MACROS
## 
##
#set($userName = "$!request.u")
#set($validationString = "$!request.v")
#set($password = "$!request.p")
#set($password2 = "$!request.p2")
#verifyRequest($userName $validationString $result)
{{/velocity}}

{{velocity}}
##
##
## First, check if the page has programming rights, as nothing works otherwise
#if($xwiki.hasProgrammingRights())
#if($result)
  #set($vuserDoc = $xwiki.getDocument($userName))
  #if($request.getParameterMap().containsKey('p'))## Second step, set the user password
    #if($password == '')
      #displayForm($msg.get('xe.admin.passwordreset.notempty') $userName $validationString)
    #elseif($password != $password2)
      #displayForm($msg.get('xe.admin.passwordreset.nomatch') $userName $validationString)
    #else
      $vuserDoc.getObject('XWiki.XWikiUsers').set('password', $password)
      #set($discard = $vuserDoc.removeObjects($verifClass))
      $vuserDoc.saveWithProgrammingRights()
{{info}}$msg.get('xe.admin.passwordreset.success') {{html}}&lt;a href='$xwiki.getURL('XWiki.XWikiLogin', 'login')'&gt;$msg.get('xe.admin.passwordreset.loginsmall')&lt;/a&gt;{{/html}} $msg.get('xe.admin.passwordreset.successend'){{/info}}

    #end
  #else## First step, request the user password
    ## The user might not complete this step, and leave the URL in the (public) browser's
    ## history. Prevent reusing the URL by invalidating the initial verification URL and only
    ## post the new string in the hidden form data.
    #set($validationString = $util.generateRandomString(30))
    $vuserDoc.getObject($verifClass).set('verification', $validationString)
    $vuserDoc.saveWithProgrammingRights()
    #displayForm('' $userName $validationString)
  #end
#else
  #set($backToResetLink = " [[$msg.get('xe.admin.passwordreset.backtoreset') »&gt;&gt;ResetPassword]]")

{{error}}$msg.get('xe.admin.passwordreset.wrongparameters') ${backToResetLink}{{/error}}

#end
##
## Clear private variables, so that they cannot be accessed from the rest of the page (comments, panels...)
#set($validationString = '')
#set($password = '')
#set($password2 = '')
##
##
#else## No programming rights, warn and exit

{{error}}$msg.get('xe.admin.passwordreset.noprogrammingrights'){{/error}}

#end
{{/velocity}}</content></xwikidoc>
