<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>XWiki</web>
<name>WatchListMessage</name>
<language></language>
<defaultLanguage></defaultLanguage>
<translation>0</translation>
<parent>XWiki.WebHome</parent>
<creator></creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1203938786000</creationDate>
<date>1205320524000</date>
<contentUpdateDate>1205320524000</contentUpdateDate>
<version>4.1</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<object>
<class>
<name>XWiki.Mail</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<html>
<name>html</name>
<number>4</number>
<prettyName>HTML</prettyName>
<rows>15</rows>
<size>80</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</html>
<language>
<name>language</name>
<number>2</number>
<prettyName>Language</prettyName>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</language>
<subject>
<name>subject</name>
<number>1</number>
<prettyName>Subject</prettyName>
<size>40</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</subject>
<text>
<name>text</name>
<number>3</number>
<prettyName>Text</prettyName>
<rows>15</rows>
<size>80</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</text>
</class>
<name>XWiki.WatchListMessage</name>
<number>0</number>
<className>XWiki.Mail</className>
<property>
<html>&lt;body style="background-color:#F7F7F7;"&gt;
&lt;b&gt;Hello $pseudo,&lt;/b&gt;&lt;br/&gt;
&lt;i&gt;This message is sent by XWiki. Here are the documents in your watchlist that have been created or updated since the last notification :&lt;/i&gt;&lt;br/&gt;
&lt;br/&gt;
&lt;table width="100%" style="font-family:arial;font-size:14px;" cellpadding="4" cellspacing="0"&gt;
&lt;tr style="background-color:$DEDEDE;font-weight:bold;"&gt;
&lt;td&gt;Page&lt;/td&gt;&lt;td&gt;Informations&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td colspan="2"&gt;&lt;/td&gt;&lt;/tr&gt;
## ------------------------------------------
## Loop over the modified documents
## ------------------------------------------
#foreach ($udocname in $documents)
#set ($identifiedModification = false)
#set ($udoc = $xwiki.getDocument($udocname))
#if ($velocityCount % 2 == 0)
  #set ($color = "#FFF")
#else
  #set ($color = "#FFF")
#end
## ------------------------------------------
## 1st line : doc name, last author, etc
## ------------------------------------------
&lt;tr style="background-color:${color};"&gt;
&lt;td style="border-top:1px solid #999999;border-left:1px solid #999999;border-bottom:1px solid #999999;font-weight:bold;"&gt;&lt;a href="${udoc.getExternalURL()}"&gt;$udoc.getDisplayTitle()&lt;/a&gt;&lt;br/&gt;&lt;span style="font-size:10px;"&gt;${udoc.fullName}&lt;/span&gt;&lt;/td&gt;
&lt;td style="border-top:1px solid #999999;border-right:1px solid #999999;"&gt;
modified by $xwiki.getLocalUserName($udoc.author, false) on $xwiki.formatDate($udoc.date) #if (!$udoc.getComment().equals("")), comment : $udoc.getComment() #end
&lt;/td&gt;
&lt;/tr&gt;
#if ($interval == 1)
  #set ($period = $xwiki.getCriteriaService().getPeriodFactory().createSinceHoursPeriod(1))
#elseif ($interval == 2)
  #set ($period = $xwiki.getCriteriaService().getPeriodFactory().createSinceDaysPeriod(1))
#elseif ($interval == 3)
  #set ($period = $xwiki.getCriteriaService().getPeriodFactory().createSinceWeeksPeriod(1))
#else
  #set ($period = $xwiki.getCriteriaService().getPeriodFactory().createSinceYearsPeriod(1))
#end
#set ($criteria = $xwiki.getCriteriaService().getRevisionCriteriaFactory().createRevisionCriteria($period))
#set ($ret = $criteria.setRange($xwiki.getCriteriaService().getRangeFactory().createRange(0, 1)))
#set ($revisions = $udoc.getRevisions($criteria))
#foreach ($rev in $revisions)
  #set ($rev1 = $rev)
#end
#set ($rev2 = $udoc.getVersion())
#set($origdoc = $xwiki.getDocument($udoc, $rev1))
#set($newdoc = $udoc)
## ------------------------------------------
## 2nd line : differences
## ------------------------------------------
&lt;tr style="background-color:${color};"&gt;
&lt;td style="background-color:#F7F7F7;"&gt;&lt;/td&gt;
&lt;td style="border-bottom:1px solid #999999;border-right:1px solid #999999;border-left:1px solid #999999;"&gt;
## ------------------------------------------
## Content
## ------------------------------------------
##
#macro(displayhtmldiff $html)
##set ($html = $html.replaceAll('\&lt;span class="diffremoveword"\&gt;(.*)\&lt;/span\&gt;', '\&lt;span style="font-style:bold;color:red;"\&gt;\&lt;strike\&gt;$1\&lt;/strike\&gt;\&lt;/span\&gt;'))
#set ($html = $html.replaceAll('class="diffremoveword"', 'style="text-decoration: line-through;color:red;"'))
#set ($html = $html.replaceAll('class="diffaddword"', 'style="font-weight:bold;color:green;"'))
$html
#end
#if($origdoc.get("XWiki.ArticleClass"))
  ##
  ## blog article
  ##
  #set($ok = $origdoc.use("XWiki.ArticleClass"))
  #set($origcontent = $!origdoc.getValue("content").trim())
  #if(!$origcontent)
    #set($text1 = "")
  #else
    #set($text1 = $origcontent)
  #end
  #set($ok = $newdoc.use("XWiki.ArticleClass"))
  #set($newcontent = $!newdoc.getValue("content").trim())
  #if(!$newcontent)
    #set($text2 = "")
  #else
    #set($text2 = $newcontent)
  #end
  #set ($htmlDiff = $xwiki.diff.getDifferencesAsHTML($text1, $text2 ,false))
  ## !$text1.equals($text2) was failing
  #if(!$htmlDiff.replaceAll('\&lt;div class="diff"\&gt;\&lt;/div\&gt;', "").trim().equals(""))
    #set ($identifiedModification = true)
    &lt;table class="changes-table" width="100%" style="border-color:#CDCDCD;font-family:arial;font-size:12px;text-align:left;"&gt;
      &lt;tr class="changes-table-title"&gt;
        &lt;th style="border-bottom:1px solid #000000;"&gt;Content&lt;/th&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;
          $htmlDiff
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;/table&gt;
  #end
#else
  ##
  ## Wiki page
  ##
  #set($origcontent = $!origdoc.content.trim())
  #if(!$origcontent)
    #set($text1 = "")
  #else
    #set($text1 = $origcontent)
  #end
  #set($newcontent = $!newdoc.content.trim())
  #if(!$newcontent)
    #set($text2 = "")
  #else
    #set($text2 = $newcontent)
  #end
  #set ($htmlDiff = $xwiki.diff.getDifferencesAsHTML($text1, $text2 ,false).replaceAll('\&lt;div class="diff"\&gt;\&lt;/div\&gt;', "").trim())
  ## !$text1.equals($text2) was failing
  #if(!$htmlDiff.equals(""))
    #set ($identifiedModification = true)
    &lt;table class="changes-table" width="100%" style="border-color:#CDCDCD;font-family:arial;font-size:12px;text-align:left;"&gt;
      &lt;tr class="changes-table-title"&gt;
        &lt;th style="border-bottom:1px solid #000000;"&gt;Content&lt;/th&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;
          #displayhtmldiff($htmlDiff)
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;/table&gt;
  #end
#end
## ------------------------------------------
## Comments
## ------------------------------------------
#set($commentchanges = 0)
#foreach($objdiffs in $newdoc.getObjectDiff($origdoc, $newdoc))
  #set($commentchangetitledone = 0)
  #foreach($objdiff in $objdiffs)
    #if($objdiff.getClassName().equals("XWiki.XWikiComments"))
      #if($commentchangetitledone==0)
        #set($commentchanges = 1 + $commentchanges)
        #set($commentchangetitledone = 1)
      #end
    #end
  #end
#end
#if($commentchanges&gt;0)
#set ($identifiedModification = true)
&lt;table class="changes-table" width="100%" style="border-color:#CDCDCD;font-family:arial;font-size:12px;text-align:left;"&gt;
&lt;tr class="changes-table-title" style="border-bottom:1px solid #000000;"&gt;
&lt;th style="border-bottom:1px solid #000000;"&gt;Comment&lt;/th&gt;
&lt;/tr&gt;
#foreach($objdiffs in $newdoc.getObjectDiff($origdoc, $newdoc))
  #set ($wascomment = false)
  #set ($author = "")
  #set ($date = "")
  #set ($comment = "")
  #foreach($objdiff in $objdiffs)
    #if($objdiff.getClassName().equals("XWiki.XWikiComments"))
      #set ($wascomment = true)
      #set($propname = $objdiff.getPropName())
      #if($propname=="author")
        #set($author = $objdiff.getNewValue().toString())
        #if($author!="")
          #set ($author = $xwiki.renderText($xwiki.getLocalUserName($author),$newdoc))
        #end
      #elseif ($propname=="date")
        #set($date = $objdiff.getNewValue().toString())
      #elseif ($propname=="comment")
        #set($comment = $objdiff.getNewValue().toString())
      #end
    #else
      #set($wascomment = false)
    #end
  #end
  #if ($comment!="")
    &lt;tr&gt;
      &lt;td&gt;
         Added by $author on $date : &lt;br/&gt;
         &lt;br/&gt;
         $comment
      &lt;/td&gt;
    &lt;/tr&gt;
  #end
#end
&lt;/table&gt;
#end
## ------------------------------------------
## Attachments
## ------------------------------------------
#set($attachChanges = $newdoc.getAttachmentDiff($origdoc, $newdoc))
#if ($attachChanges &amp;&amp; $attachChanges.size() &gt; 0)
#set ($identifiedModification = true)
  &lt;table class="changes-table" width="100%" style="border-color:#CDCDCD;font-family:arial;font-size:12px;text-align:left;"&gt;
    &lt;tr class="changes-table-title"&gt;
      &lt;th style="border-bottom:1px solid #000000;"&gt;Attachment&lt;/th&gt;
    &lt;/tr&gt;
    #foreach($attachChange in $attachChanges)
      &lt;tr&gt;
        &lt;td&gt;
          #if(!$attachChange.origVersion)
            Attachment added : &lt;a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)"&gt;$attachChange.fileName&lt;/a&gt;
          #elseif(!$attachChange.newVersion)
            Attachment deleted : $attachChange.fileName
          #else
            Attachment updated from version &lt;a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.origVersion)"&gt;$attachChange.origVersion&lt;/a&gt;
            to version &lt;a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)"&gt;$attachChange.newVersion&lt;/a&gt;
          #end
        &lt;/td&gt;
      &lt;/tr&gt;
    #end
  &lt;/table&gt;
#end
##
## / Differences
##
#if (!$identifiedModification)
Modifications on page objects or class
#end
&lt;/td&gt;
&lt;/tr&gt;
##
## Spacer
##
&lt;tr&gt;
  &lt;td&gt;&amp;nbsp;&lt;/td&gt;
  &lt;td&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
#end
&lt;/table&gt;
&lt;/body&gt;</html>
</property>
<property>
<language>en</language>
</property>
<property>
<subject>XWiki : Watchlist Updates, #set($format="dd/MM/yyyy")#if ($interval == 1)#set($format="${format} hh:mm")#end$xwiki.formatDate($util.date, $format)</subject>
</property>
<property>
<text>Hello $pseudo,
This message is sent by XWiki. Here are the documents in your watchlist that have been created or updated since the last notification :

#foreach ($udocname in $documents)
#set ($udoc = $xwiki.getDocument($udocname))$udoc.getDisplayTitle() : ${udoc.getExternalURL()}
#end</text>
</property>
</object>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>XWiki.WatchListMessage</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>
</content></xwikidoc>