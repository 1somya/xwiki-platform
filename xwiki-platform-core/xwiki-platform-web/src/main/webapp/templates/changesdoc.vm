#macro (unifiedDiff $previous $next)
  #set ($discard = $xwiki.ssfx.use('uicomponents/viewers/diff.css', true))
  <table class="diff">
  #foreach ($block in $services.diff.display.unified($previous, $next))
    <tr>
      <td class="lineNumber">...</td>
      <td class="lineNumber">...</td>
      <td class="line meta">@@ -$mathtool.add($block.previousStart, 1),$block.previousSize +$mathtool.add($block.nextStart, 1),$block.nextSize @@</td>
    </tr>
    #foreach ($line in $block)
    <tr>
      #set ($lineNumber = $line.index + 1)
      <td class="lineNumber">#if (!$line.added)$lineNumber#end</td>
      <td class="lineNumber">#if (!$line.deleted)$lineNumber#end</td>
      <td class="line $line.type.toString().toLowerCase()">#unifiedDiffLine($line)</td>
    </tr>
    #end
  #end
  </table>
#end

#macro (unifiedDiffLine $line)
${line.type.symbol}##
#if ($line.chunks)##
#inlineDiffLine($line.chunks)##
#else##
$escapetool.html($line.value)##
#end
#end

#macro (inlineDiff $previous $next)
  #set ($discard = $xwiki.ssfx.use('uicomponents/viewers/diff.css', true))
  <div class="diff">
    <div class="line">#inlineDiffLine($services.diff.display.inline($previous, $next))</div>
  </div>
#end

#macro (inlineDiffLine $chunks)
#foreach ($chunk in $chunks)
#set ($escapedChunk = $escapetool.html($chunk))
#if ($chunk.added)##
<ins>$escapedChunk</ins>##
#elseif ($chunk.deleted)##
<del>$escapedChunk</del>##
#else##
$escapedChunk##
#end
#end
#end

#macro(displayPropertyChange $diff $propertyDisplay)
  <tr>
    <td>$propertyDisplay</td>
    #if ("$!diff.propType" == 'TextAreaClass')
      <td>#unifiedDiff($diff.prevValue $diff.newValue)</td>
    #else
      <td>#inlineDiff($diff.prevValue $diff.newValue)</td>
    #end
  </tr>
#end

#set($commentsChanges = [])
#set($objectsChanges = [])
#foreach($objectDiff in $doc.getObjectDiff($origdoc, $newdoc))
  #if($objectDiff.get(0).getClassName() == 'XWiki.XWikiComments')
    #set($discard = $commentsChanges.add($objectDiff))
  #elseif($objectDiff.get(0).getClassName() == 'XWiki.TagClass')
    #if("$!objDiff.get(0).newValue" != "$!objectDiff.get(0).oldValue")
      #set($tagsChanges = $objectDiff)
    #end
  #else
    #set($discard = $objectsChanges.add($objectDiff))
  #end
#end
#set($hasChanges = false)
##
## Preamble: which versions are being compared
##
<div id="changes-info">
  <div id="changes-info-boxes">
    <div id="changes-info-box-from" class="changes-info-box">
      <div class="changes-info-title">$msg.get('core.viewers.diff.from', [$rev1])</div>
      <div class="changes-info-content">
      #if($origdoc)
        $msg.get('core.viewers.diff.editedBy', [$xwiki.getUserName($origdoc.author)])
        <br />
        $msg.get('core.viewers.diff.editedOn', [$xwiki.formatDate($origdoc.date)])
      #end
      </div> ## changes-info-content
    </div> ## changes-info-box-from
    <div id="changes-info-box-to" class="changes-info-box">
      <div class="changes-info-title">$msg.get('core.viewers.diff.to', [$rev2])</div>
      <div class="changes-info-content">
      #if($newdoc)
        $msg.get('core.viewers.diff.editedBy', [$xwiki.getUserName($newdoc.author)])
        <br />
        $msg.get('core.viewers.diff.editedOn', [$xwiki.formatDate($newdoc.date)])
      #end
      </div> ## changes-info-content
    </div> ## changes-info-box-to
    <div class="clearfloats"></div>
  </div> ## changes-info-boxes
  <div class="clearfloats"></div>
  <div id="changes-info-comment">
    $msg.get('core.viewers.diff.editComment') #if("$!newdoc.comment" == '') $msg.get('core.viewers.diff.noEditComment') #else $newdoc.comment #end
  </div> ## changes-info-comment
</div> ## changes-info
<div class="clearfloats"></div>
##
## Metadata changes: tags, author, language...
##
#set($metadataChanges = $doc.getMetaDataDiff($origdoc, $newdoc))
#if($metadataChanges.size() > 0 || $tagsChanges)
  #set($hasChanges = true)
  <div id="changes-metadata">
    <table class="changes-table">
      <tr class="changes-table-title">
        <th colspan="3">$msg.get('changes.metadatachanges')</th>
      </tr>
      #foreach($propertyChange in $doc.getMetaDataDiff($origdoc, $newdoc))
        #displayPropertyChange($propertyChange $msg.get("core.viewers.diff.metadata.${propertyChange.field}"))
      #end
      #if($tagsChanges)
        #foreach($propertyChange in $tagsChanges)
          #displayPropertyChange($propertyChange $msg.get("core.viewers.diff.tag.${propertyChange.propName}"))
        #end
      #end
    </table>
  </div>
#end
##
## Content changes
##
#if($origdoc.content != $newdoc.content)
  #set($hasChanges = true)
  <dl>
    <dt>$msg.get('core.viewers.diff.contentChanges')</dt>
    <dd>#unifiedDiff($origdoc.content $newdoc.content)</dd>
  </dl>
#end
##
## Attachment changes
##
#set($attachmentsChanges = $doc.getAttachmentDiff($origdoc, $newdoc))
#if($attachmentsChanges.size() > 0)
  #set($hasChanges = true)
  <div id="changes-attachments">
    <table class="changes-table" summary="$msg.get('core.viewers.diff.summary')">
      <tr class="changes-table-title">
        <th colspan="2">$msg.get('core.viewers.diff.attachmentChanges')</th>
      </tr>
      <tr class="changes-table-title">
        <th>$msg.get('core.viewers.diff.attachment.filename')</th>
        <th>$msg.get('core.viewers.diff.attachment.action')</th>
      </tr>
      #foreach($attachChange in $doc.getAttachmentDiff($origdoc, $newdoc))
        <tr>
          <td>$attachChange.fileName</td>
          <td>
            #if(!$attachChange.origVersion)
              <a href="$newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)">$msg.get('core.viewers.diff.attachment.added')</a>
            #elseif(!$attachChange.newVersion)
              $msg.get('core.viewers.diff.attachment.deleted')
            #else
              $msg.get('core.viewers.diff.attachment.updated', [$attachChange.origVersion, $newdoc.getAttachmentRevisionURL($attachChange.fileName, $attachChange.origVersion), $attachChange.newVersion, $newdoc.getAttachmentRevisionURL($attachChange.fileName,$attachChange.newVersion)])
            #end
          </td>
        </tr>
      #end
    </table>
  </div>
#end
##
## Comment changes
##
#if($commentsChanges.size() > 0)
  #set($hasChanges = true)
  <div id="changes-comments">
    <table class="changes-table" summary="$msg.get('core.viewers.diff.summary')">
      <tr class="changes-table-title">
        <th colspan="3">$msg.get('core.viewers.diff.commentChanges')</th>
      </tr>
      #foreach($comment in $commentsChanges)
        #set($action = $comment.get(0).action)
        #if($action == 'object-added')
          <tr>
            <th colspan="3">$msg.get('core.viewers.diff.comment.added', [$comment.get(0).number])</th>
          </tr>
        #elseif($action == 'object-removed')
          <tr>
            <th colspan="3">$msg.get('core.viewers.diff.comment.deleted', [$comment.get(0).number])</th>
          </tr>
        #else
          <tr>
            <th colspan="3">$msg.get('core.viewers.diff.comment.updated', [$comment.get(0).number])</th>
          </tr>
        #end
        #foreach($propertyChange in $comment)
          #if($propertyChange.action != 'object-added' && $propertyChange.action != 'object-removed')
            #displayPropertyChange($propertyChange $msg.get("core.viewers.diff.comment.${propertyChange.propName}"))
          #end
        #end
      #end
    </table>
  </div>
#end
##
## All other objects
##
#if($objectsChanges.size() > 0)
  #set($hasChanges = true)
  <div id="changes-objects">
    <table class="changes-table" summary="$msg.get('core.viewers.diff.summary')">
      <tr class="changes-table-title">
        <th colspan="3">$msg.get('core.viewers.diff.objectChanges')</th>
      </tr>
      #foreach($object in $objectsChanges)
        #set($action = $object.get(0).action)
        #if($action == 'object-added')
          <tr><th colspan="3">$msg.get('core.viewers.diff.object.added', [$object.get(0).number, $object.get(0).className])</th></tr>
        #elseif($action == 'object-removed')
          <tr><th colspan="3">$msg.get('core.viewers.diff.object.deleted', [$object.get(0).number, $object.get(0).className])</th></tr>
        #else
          <tr><th colspan="3">$msg.get('core.viewers.diff.object.updated', [$object.get(0).number, $object.get(0).className])</th></tr>
        #end
        #foreach($propertyChange in $object)
          #if ($propertyChange.action != 'object-added' && $propertyChange.action != 'object-removed')
            #set ($class = $xwiki.getDocument($object.get(0).className).getxWikiClass())
            #set ($propertyPrettyName = "$!{class.get(${propertyChange.propName}).getPrettyName()}")
            #if ($propertyPrettyName == '')
              #set ($propertyPrettyName = ${propertyChange.propName})
            #end
            #displayPropertyChange ($propertyChange ${propertyPrettyName})
          #end
        #end
      #end
    </table>
  </div>
#end
##
## Class changes
##
#set($classChanges = $doc.getClassDiff($origdoc, $newdoc))
#if(($classChanges.size() > 0) && ($classChanges.get(0).size() > 0))
  #set($hasChanges = true)
  <div id="changes-classes">
    <table class="changes-table" summary="$msg.get('core.viewers.diff.summary')">
      <tr class="changes-table-title">
        <th>$msg.get('core.viewers.diff.classChanges')</th>
      </tr>
      #foreach($classChange in $classChanges)
        #foreach($propertyChange in $classChange)
          <tr><td>$msg.get("core.viewers.diff.class.${propertyChange.action}", [$propertyChange.propName])</td></tr>
        #end
      #end
    </table>
  </div>
#end

#if(!$hasChanges)
  #info("No changes")
#end
