#macro(handleStepAction $action)
  #set ($distributionJobStatus = $services.distribution.jobStatus)
  #set ($distributionQuestion = $distributionJobStatus.question)
  #if ($distributionQuestion)
    $distributionQuestion.setUpdateState($action)
    $distributionJobStatus.answered()
  #end
  $response.sendRedirect($xwiki.getURL('XWiki.Distribution', 'distribution', "xredirect=$!escapetool.url($request.xredirect)"))
#end

#macro(displayStep)
  #template('xwikivars.vm')
  #template('htmlheader.vm')
  $xwiki.ssfx.use('uicomponents/extension/distribution.css')
  <div class="xdialog-modal-container">
    <div class="xdialog-screen"></div>
    <div class="xdialog-box">
      <div class="xdialog-title">Distribution Wizard</div>
      <div class="xdialog-content">
        #displayStepContent()
        #displayStepButtons()
      </div>
    </div>
  </div>
  #template('htmlfooter.vm')
#end

#macro(displayStepContent)
  #set ($stepId = $services.distribution.jobStatus.question.stepId)
  #if ($stepId == 'extension.mainui')
    #displayMainUIStep()
  #elseif ($stepId == 'extension.outdatedextensions')
    #displayOutdatedExtensionsStep()
  #else
    <div class="box errormessage">Unknown step</div>
  #end
#end

#macro(displayMainUIStep)
  #set ($distributionState = $services.distribution.state)
  #if ($distributionState == 'NONE')
    <div class="box errormessage">Can't get any information about the distribution.</div>
  #else
    <p>The following distribution has been detected:</p>
    #set ($distributionExtension = $services.distribution.distributionExtension)
    #displayExtension($distributionExtension)
    #set ($distributionUIId = $services.distribution.getUIExtensionId())
    #if ($distributionUIId)
      <p>The following user interface is recommended for your distribution:</p>
      #set ($distributionUIExtension = $services.extension.resolve($distributionUIId.id, $distributionUIId.version.value))
      #displayExtension($distributionUIExtension)
    #else
      <div class="box warningmessage">The detected distribution doesn't specify a default UI.</div>
    #end
  #end
#end

#macro(displayOutdatedExtensionsStep)
  <p>TODO: Display outdated extensions</p>
#end

#macro(displayStepButtons)
  <form action="" class="xform">
    <div class="buttons">
      #if ($request.xredirect)
        <input type="hidden" name="xredirect" value="$escapetool.xml($request.xredirect)" />
      #end
      <span class="buttonwrapper"><button class="button" type="submit" name="action" value="COMPLETE_STEP">Continue</button></span>
      <span class="buttonwrapper"><button class="button secondary" type="submit" name="action" value="SKIP_STEP">Skip</button></span>
      <span class="buttonwrapper"><button class="button secondary" type="submit" name="action" value="CANCEL_STEP">Cancel</button></span>
    </div>
  </form>
#end

#if ($services.distribution.jobStatus.state == 'FINISHED')
  #set ($redirectURL = $request.xredirect)
  #if ("$!redirectURL" == '')
    #set ($redirectURL = $xwiki.getURL('Main.WebHome'))
  #end
  $response.sendRedirect($redirectURL)
#elseif ("$!request.action" != '')
  #handleStepAction($request.action)
#else
  ## NOTE: We use #parse instead of #template because the later currently registers the Velocity macros in a different
  ## namespace which makes them unavailable in the current wiki page or the current template. Switch back to #template when
  ## this problem is fixed because #parse doesn't allow the template to be overridden from the skin.
  #parse('extension.vm')
  #if ($isAjaxRequest)
    #handleExtensionRequest()
  #else
    #displayStep()
  #end
#end