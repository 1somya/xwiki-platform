#macro(handleStepAction $action)
  #set ($distributionJobStatus = $services.distribution.jobStatus)
  #set ($distributionQuestion = $distributionJobStatus.question)
  #if ($distributionQuestion)
    $distributionQuestion.setUpdateState($action)
    $distributionJobStatus.answered()
  #end
  $response.sendRedirect($xwiki.getURL('XWiki.Distribution', 'distribution', "xredirect=$!escapetool.url($request.xredirect)"))
#end

#macro(displayStep)
  #template('xwikivars.vm')
  #template('htmlheader.vm')
  $xwiki.ssfx.use('uicomponents/extension/distribution.css')
  $xwiki.jsfx.use('uicomponents/extension/distribution.js', true)
  #set ($stepId = $services.distribution.jobStatus.question.stepId)
  <div id="$!stepId" class="xdialog-modal-container">
    <div class="xdialog-screen"></div>
    <div class="xdialog-box">
      <div class="xdialog-title">Distribution Wizard</div>
      <div class="xdialog-content">
        #if ($request.extensionId && $request.extensionVersion)
          ## The user can get here by clicking on an extension link.
          #handleExtensionRequest()
        #else
          #displayStepContent($stepId)
          #displayStepButtons()
        #end
      </div>
    </div>
  </div>
  #template('htmlfooter.vm')
#end

#macro(displayStepContent $stepId)
  #if ($stepId == 'extension.mainui')
    #displayMainUIStep()
  #elseif ($stepId == 'extension.outdatedextensions')
    #displayOutdatedExtensionsStep()
  #else
    <div class="box errormessage">Unknown step</div>
  #end
#end

#macro(displayMainUIStep)
  #set ($distributionState = $services.distribution.state)
  #if ($distributionState == 'NONE')
    <div class="box errormessage">Can't get any information about the distribution.</div>
  #else
    <p>The following distribution has been detected:</p>
    #set ($distributionExtension = $services.distribution.distributionExtension)
    #displayExtension($distributionExtension)

    #set ($distributionUIId = $services.distribution.getUIExtensionId())
    #if ($distributionUIId)
      #set ($installedVersion = $services.extension.getInstalledExtension($distributionUIId.id, 'wiki:xwiki'))
      #set ($showCompleteStepButton = $installedVersion.isValid('wiki:xwiki'))

      ## Allow the user to install, upgrade or downgrade the UI.
      <p>The following user interface is recommended for your distribution:</p>
      #set ($distributionUIExtension = $services.extension.resolve($distributionUIId.id, $distributionUIId.version.value))
      #displayExtension($distributionUIExtension)

      #if ($distributionState == 'NEW' && !$showCompleteStepButton)
        ## Either a new install or an upgrade from a version that doesn't have the distribution module.
        ## TODO: Ask the user if a previous version of the UI was installed without the Extension Manager. Retrieve the
        ## list of versions available for the recommended UI and let the user choose the version he's currently using.
        ## Do a fake install of the selected version.
      #elseif ($distributionState == 'DIFFERENT')
        ## TODO: Display the previous distribution UI extension to let the user uninstall it.
      #end
    #else
      <div class="box warningmessage">The detected distribution doesn't specify a default UI.</div>
      ## TODO: Display the Extension Manager search bar so that the user can search for an extension that provides the main UI.
    #end
  #end
#end

#macro(displayOutdatedExtensionsStep)
  <p>TODO: Display outdated extensions</p>
#end

#macro(displayStepButtons)
  <form action="" class="xform">
    <div id="stepButtons" class="buttons">
      #if ($request.xredirect)
        <input type="hidden" name="xredirect" value="$escapetool.xml($request.xredirect)" />
      #end
      ## Normally we shouldn't generate the buttons that are not supposed to be visible but we want to simplify the
      ## JavaScript code and to avoid duplicating the HTML by adding the buttons dynamically.
      <span class="buttonwrapper#if (!$showCompleteStepButton) hidden#end">
        <button type="submit" name="action" value="COMPLETE_STEP">Continue</button>
      </span>
      <span class="buttonwrapper#if ($showCompleteStepButton) hidden#end">
        <button class="secondary" type="submit" name="action" value="SKIP_STEP" title="Ask me again after a server restart">Skip</button>
      </span>
      <span class="buttonwrapper#if ($showCompleteStepButton) hidden#end">
        <button class="secondary" type="submit" name="action" value="CANCEL_STEP" title="Ask me again when I change my distribution">Cancel</button>
      </span>
    </div>
  </form>
#end

#if ($services.distribution.jobStatus.state == 'FINISHED')
  #set ($redirectURL = $request.xredirect)
  #if ("$!redirectURL" == '')
    #set ($redirectURL = $xwiki.getURL('Main.WebHome'))
  #end
  $response.sendRedirect($redirectURL)
#elseif ("$!request.action" != '')
  #handleStepAction($request.action)
#else
  ## NOTE: We use #parse instead of #template because the later currently registers the Velocity macros in a different
  ## namespace which makes them unavailable in the current wiki page or the current template. Switch back to #template when
  ## this problem is fixed because #parse doesn't allow the template to be overridden from the skin.
  #parse('extension.vm')
  #if ($isAjaxRequest)
    #handleExtensionRequest()
  #else
    #displayStep()
  #end
#end