###
### Template used by the delete page to display extensions that could be broken by a bad delete or move action.
### TODO: handle move action too
### TODO: use translation keys
###
#set ($jobId = "$!request.jobId")
#if ($jobId != '')
  #set ($job = $services.job.getJobStatus($jobId.split('/')))
  #if ("$!request.cancel" == 'true')
    #set ($discard = $job.cancel())
    #set ($discard = $job.answered())
  #elseif ("$!request.selection" != '')
    ## Parse the selection
    #set ($selection = $jsontool.parse($request.selection))
    #set ($question = $job.question)
    #if ($selection.allExtensions)
      #set ($discard = $question.selectAllExtensions())
    #end
    #if ($selection.allFreePages)
      #set ($discard = $question.selectAllFreePages())
    #end
    #foreach ($extension in $selection.extensions)
      #set ($extensionSelection = $question.getExtension($extension))
      #set ($discard = $extensionSelection.selectAllPages())
    #end
    #foreach ($page in $selection.pages)
      #set ($pageRef = $services.model.resolveDocument($page, 'default'))
      #set ($pageSelection = $question.get($pageRef))
      #set ($discard = $pageSelection.setSelected(true))
    #end
    #set ($discard = $job.answered())
  #else
    #set ($question = $job.question)
    ## TODO: move that to the skin!
    <style>
      .jstree-xwiki .paginationNode .jstree-checkbox {
        display: none;
      }
    </style>
    <div class="box warningmessage" style="margin-top: 10px;">
      <p><strong>$services.icon.renderHTML('warning') You are about about to delete pages that belong to extensions.</strong></p>
      <p>If you delete these pages, the extensions will not work anymore.</p>
      <p>The recommended way of removing an extension is by uninstalling it with the <a href="$xwiki.getURL($services.model.createDocumentReference('', 'XWiki', 'XWikiPreferences'), 'admin', 'editor=globaladmin&section=XWiki.InstalledExtensions')">Extension Manager</a>.</p>
      <p>Do you wish to continue?</p>
      <div class="panel panel-default">
        <div class="panel-heading">
          <p class="panel-title">Pages to remove</p>
        </div>
        <div class="panel-body">
          <p><a href="#" class="btSelectAllTree">select all</a> / <a href="#" class="btUnselectAllTree">none</a></p>
          <div class="deleteTree" data-url="$doc.getURL('get', "xpage=refactoring/delete_question_data&jobId=$jobId")">
        </div>
      </div>
      <p>
        <button class="btn btn-danger btConfirmDelete">Delete</button>
        <button class="btn btn-default btCancelDelete">Cancel</button>
      </p>
    </div>
  #end
#end
